<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>下级会员 - <?php echo $parent['username']; ?></title>
    <link rel="stylesheet" href="/app/admin/component/layui/css/layui.css"/>
    <style>
        body {
            margin: 0;
            padding: 0;
        }
        
        .layui-card {
            margin: 15px;
        }
        
        .search-form {
            background: #fff;
            padding: 15px;
            border-bottom: 1px solid #e6e6e6;
        }
        
        .layui-table {
            width: 100% !important;
        }
        
        .layui-table-view {
            width: 100% !important;
        }
        
        .text-primary {
            color: #1E9FFF;
            cursor: pointer;
        }
        
        .layui-badge-gray {
            background-color: #999;
        }
    </style>
</head>
<body>
    <div class="layui-fluid">
        <div class="layui-card">
            <div class="layui-card-body">
                <!-- 搜索表单 -->
                <div class="search-form">
                    <form class="layui-form" lay-filter="searchForm" id="searchForm">
                        <input type="hidden" name="parentid" value="<?php echo $parent['id']; ?>">
                        
                        <div class="layui-form-item">
                            <div class="layui-inline">
                                <label class="layui-form-label" style="width:40px">类型:</label>
                                <div class="layui-input-inline" style="width:100px">
                                    <select name="proxy">
                                        <option value="999">全部</option>
                                        <option value="1">代理</option>
                                        <option value="0">会员</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="layui-inline">
                                <label class="layui-form-label" style="width:60px">用户名:</label>
                                <div class="layui-input-inline" style="width:120px">
                                    <input type="text" name="username" placeholder="输入用户名" class="layui-input"/>
                                </div>
                            </div>
                            
                            <div class="layui-inline">
                                <button class="layui-btn" lay-submit lay-filter="search">
                                    <i class="layui-icon">&#xe615;</i>搜索
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
                
                <!-- 数据表格 -->
                <table id="dataTable" lay-filter="dataTable"></table>
            </div>
        </div>
    </div>

    <!-- 操作列模板 -->
    <script type="text/html" id="operationTpl">
        <button class="layui-btn layui-btn-primary layui-btn-xs" lay-event="info">资料</button>
        <button class="layui-btn layui-btn-primary layui-btn-xs" lay-event="balance">帐变</button>
        <button class="layui-btn layui-btn-primary layui-btn-xs" lay-event="children">下级</button>
    </script>

    <script src="/app/admin/component/layui/layui.js"></script>
    <script>
        layui.use(['table', 'form', 'layer'], function() {
            var table = layui.table;
            var form = layui.form;
            var layer = layui.layer;
            var $ = layui.$;
            
            // 渲染表格
            var tableIns = table.render({
                elem: '#dataTable',
                url: '/app/admin/member/list',
                where: {parentid: <?php echo $parent['id']; ?>},
                page: true,
                limit: 20,
                limits: [20, 50, 100],
                cols: [[
                    {field: 'id', title: 'ID', width: 80, align: 'center', sort: true},
                    {field: 'groupname', title: '会员组', width: 100, align: 'center', templet: function(d) {
                        return '<span class="layui-badge layui-badge-gray">' + (d.groupname || '') + '</span>';
                    }},
                    {field: 'username', title: '用户名', width: 120, align: 'center', templet: function(d) {
                        return '<span class="text-primary">' + (d.username || '') + '</span>';
                    }},
                    {field: 'userbankname', title: '姓名', width: 100, align: 'center'},
                    {field: 'proxy_text', title: '类型', width: 80, align: 'center', templet: function(d) {
                        return '<span class="layui-badge layui-badge-gray">' + (d.proxy_text || '') + '</span>';
                    }},
                    {field: 'balance', title: '金额', width: 120, align: 'center', templet: function(d) {
                        return '<span class="text-primary">' + parseFloat(d.balance || 0).toFixed(3) + '</span>';
                    }},
                    {field: 'point', title: '积分', width: 100, align: 'center'},
                    {field: 'logintime_text', title: '登陆时间', width: 120, align: 'center'},
                    {field: 'isonline_text', title: '状态', width: 80, align: 'center', templet: function(d) {
                        var cls = d.isonline_text === '在线' ? '' : 'layui-badge-gray';
                        return '<span class="layui-badge ' + cls + '">' + d.isonline_text + '</span>';
                    }},
                    {field: 'regtime_text', title: '注册时间', width: 140, align: 'center'},
                    {fixed: 'right', title: '操作', width: 200, align: 'center', toolbar: '#operationTpl'}
                ]]
            });
            
            // 搜索
            form.on('submit(search)', function(data) {
                tableIns.reload({
                    where: data.field,
                    page: {
                        curr: 1
                    }
                });
                return false;
            });
            
            // 表格行工具事件
            table.on('tool(dataTable)', function(obj) {
                var data = obj.data;
                
                if (obj.event === 'info') {
                    // 资料
                    layer.open({
                        type: 2,
                        title: '会员资料 - ' + data.username,
                        area: ['600px', '80%'],
                        content: '/app/admin/member/info?id=' + data.id
                    });
                } else if (obj.event === 'balance') {
                    // 帐变
                    layer.open({
                        type: 2,
                        title: '帐变记录 - ' + data.username,
                        area: ['90%', '90%'],
                        content: '/app/admin/member/balance-log?uid=' + data.id
                    });
                } else if (obj.event === 'children') {
                    // 下级
                    layer.open({
                        type: 2,
                        title: '下级会员 - ' + data.username,
                        area: ['90%', '90%'],
                        content: '/app/admin/member/children?parentid=' + data.id
                    });
                }
            });
        });
    </script>
</body>
</html>

