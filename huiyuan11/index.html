<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>会员管理</title>
    <link rel="stylesheet" href="/app/admin/component/layui/css/layui.css"/>
    <style type="text/css">
        body {
            margin: 0;
            padding: 0;
        }
        
        .layui-card {
            margin: 15px;
        }
        
        .search-form {
            background: #fff;
            padding: 15px;
            border-bottom: 1px solid #e6e6e6;
        }
        
        .layui-table {
            width: 100% !important;
        }
        
        .layui-table-view {
            width: 100% !important;
        }
        
        .text-primary {
            color: #1E9FFF;
            cursor: pointer;
        }
        
        .text-primary:hover {
            text-decoration: underline;
        }
        
        .layui-badge-gray {
            background-color: #999;
        }
        
        /* 操作按钮样式 - 使用自定义class */
        .btn-edit {
            background-color: #009688 !important;
            border-color: #009688 !important;
            color: #fff !important;
        }
        
        .btn-delete {
            background-color: #FF5722 !important;
            border-color: #FF5722 !important;
            color: #fff !important;
        }
        
        .btn-kick {
            background-color: #FFB800 !important;
            border-color: #FFB800 !important;
            color: #fff !important;
        }
        
        .btn-edit:hover {
            background-color: #00796B !important;
            border-color: #00796B !important;
        }
        
        .btn-delete:hover {
            background-color: #E64A19 !important;
            border-color: #E64A19 !important;
        }
        
        .btn-kick:hover {
            background-color: #FFA000 !important;
            border-color: #FFA000 !important;
        }
    </style>
</head>
<body>
    <div class="layui-fluid">
        <div class="layui-card">
            <div class="layui-card-body">
                <!-- 搜索表单 -->
                <div class="search-form">
                    <form class="layui-form" lay-filter="searchForm" id="searchForm">
                        <div class="layui-form-item">
                            <div class="layui-inline">
                                <button type="button" class="layui-btn" id="addBtn">
                                    <i class="layui-icon">&#xe654;</i>添加会员
                                </button>
                            </div>
                            
                            <div class="layui-inline">
                                <label class="layui-form-label" style="width:40px">排序:</label>
                                <div class="layui-input-inline" style="width:150px">
                                    <select name="ordertype">
                                        <option value="0">默认排序</option>
                                        <option value="1">注册时间低到高</option>
                                        <option value="2">彩票返点高到低</option>
                                        <option value="3">彩票返点低到高</option>
                                        <option value="4">账户金额高到低</option>
                                        <option value="5">账户金额低到高</option>
                                        <option value="6">账户积分高到低</option>
                                        <option value="7">账户积分低到高</option>
                                        <option value="8">洗码余额高到低</option>
                                        <option value="9">洗码余额低到高</option>
                                        <option value="16">登陆时间高到低</option>
                                        <option value="17">登陆时间低到高</option>
                                        <option value="18">在线时间高到低</option>
                                        <option value="19">在线时间低到高</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="layui-inline">
                                <label class="layui-form-label" style="width:60px">会员组:</label>
                                <div class="layui-input-inline" style="width:120px">
                                    <select name="groupid" id="groupid">
                                        <option value="0">全部</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="layui-inline">
                                <label class="layui-form-label" style="width:40px">类型:</label>
                                <div class="layui-input-inline" style="width:100px">
                                    <select name="proxy">
                                        <option value="999">全部</option>
                                        <option value="1">代理</option>
                                        <option value="0">会员</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="layui-inline">
                                <label class="layui-form-label" style="width:40px">内部:</label>
                                <div class="layui-input-inline" style="width:100px">
                                    <select name="isnb">
                                        <option value="999">全部</option>
                                        <option value="1">是</option>
                                        <option value="0">否</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="layui-inline">
                                <label class="layui-form-label" style="width:60px">用户名:</label>
                                <div class="layui-input-inline" style="width:120px">
                                    <input type="text" name="username" placeholder="输入用户名" class="layui-input"/>
                                </div>
                            </div>
                            
                            <div class="layui-inline">
                                <label class="layui-form-label" style="width:40px">姓名:</label>
                                <div class="layui-input-inline" style="width:120px">
                                    <input type="text" name="userbankname" placeholder="输入姓名" class="layui-input"/>
                                </div>
                            </div>
                            
                            <div class="layui-inline">
                                <label class="layui-form-label" style="width:40px">QQ:</label>
                                <div class="layui-input-inline" style="width:120px">
                                    <input type="text" name="qq" placeholder="输入QQ" class="layui-input"/>
                                </div>
                            </div>
                            
                            <div class="layui-inline">
                                <label class="layui-form-label" style="width:40px">昵称:</label>
                                <div class="layui-input-inline" style="width:120px">
                                    <input type="text" name="nickname" placeholder="输入昵称" class="layui-input"/>
                                </div>
                            </div>
                            
                            <div class="layui-inline">
                                <label class="layui-form-label" style="width:60px">登陆IP:</label>
                                <div class="layui-input-inline" style="width:120px">
                                    <input type="text" name="loginip" placeholder="输入登陆IP" class="layui-input"/>
                                </div>
                            </div>
                            
                            <div class="layui-inline">
                                <input type="checkbox" name="isonline" value="1" title="在线" lay-skin="primary">
                            </div>
                            
                            <div class="layui-inline">
                                <label class="layui-form-label" style="width:70px">注册时间:</label>
                                <div class="layui-input-inline" style="width:140px">
                                    <input type="text" name="sDate" id="sDate" placeholder="开始时间" class="layui-input"/>
                                </div>
                                <div class="layui-form-mid">-</div>
                                <div class="layui-input-inline" style="width:140px">
                                    <input type="text" name="eDate" id="eDate" placeholder="结束时间" class="layui-input"/>
                                </div>
                            </div>
                            
                            <div class="layui-inline">
                                <label class="layui-form-label" style="width:40px">金额:</label>
                                <div class="layui-input-inline" style="width:100px">
                                    <input type="text" name="sAmount" placeholder="最小金额" class="layui-input"/>
                                </div>
                                <div class="layui-form-mid">-</div>
                                <div class="layui-input-inline" style="width:100px">
                                    <input type="text" name="eAmount" placeholder="最大金额" class="layui-input"/>
                                </div>
                            </div>
                            
                            <div class="layui-inline">
                                <button class="layui-btn" lay-submit lay-filter="search">
                                    <i class="layui-icon">&#xe615;</i>搜索
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
                
                <!-- 数据表格 -->
                <table id="dataTable" lay-filter="dataTable"></table>
            </div>
        </div>
    </div>

    <!-- 操作列模板 -->
    <script type="text/html" id="operationTpl">
        <button class="layui-btn layui-btn-xs btn-edit" lay-event="edit">编辑</button>
        <button class="layui-btn layui-btn-xs btn-delete" lay-event="delete">删</button>
        <button class="layui-btn layui-btn-xs btn-kick" lay-event="kick">踢</button>
    </script>

    <!-- 资料列模板 -->
    <script type="text/html" id="infoTpl">
        <button class="layui-btn layui-btn-primary layui-btn-xs" lay-event="info">资料</button>
        <button class="layui-btn layui-btn-primary layui-btn-xs" lay-event="balance">帐变</button>
        <button class="layui-btn layui-btn-primary layui-btn-xs" lay-event="children">下级</button>
    </script>

    <script src="/app/admin/component/layui/layui.js"></script>
    <script>
        layui.use(['table', 'form', 'layer', 'laydate'], function() {
            var table = layui.table;
            var form = layui.form;
            var layer = layui.layer;
            var laydate = layui.laydate;
            var $ = layui.$;
            
            // 强制设置按钮样式的函数
            function setButtonStyles() {
                setTimeout(function() {
                    // 直接操作每个按钮的style
                    $('.btn-edit').each(function() {
                        this.style.setProperty('background-color', '#009688', 'important');
                        this.style.setProperty('border-color', '#009688', 'important');
                        this.style.setProperty('color', '#fff', 'important');
                    });
                    
                    $('.btn-delete').each(function() {
                        this.style.setProperty('background-color', '#FF5722', 'important');
                        this.style.setProperty('border-color', '#FF5722', 'important');
                        this.style.setProperty('color', '#fff', 'important');
                    });
                    
                    $('.btn-kick').each(function() {
                        this.style.setProperty('background-color', '#FFB800', 'important');
                        this.style.setProperty('border-color', '#FFB800', 'important');
                        this.style.setProperty('color', '#fff', 'important');
                    });
                }, 200);
            }
            
            // 日期选择器
            laydate.render({
                elem: '#sDate',
                type: 'date',
                format: 'yyyyMMdd'
            });
            
            laydate.render({
                elem: '#eDate',
                type: 'date',
                format: 'yyyyMMdd'
            });
            
            // 加载会员组列表
            $.ajax({
                url: '/app/admin/membergroup/list',
                type: 'GET',
                data: {page: 1, limit: 100},
                dataType: 'json',
                success: function(res) {
                    if (res.code === 0 && res.data) {
                        var html = '<option value="0">全部</option>';
                        res.data.forEach(function(item) {
                            html += '<option value="' + item.groupid + '">' + item.groupname + '</option>';
                        });
                        $('#groupid').html(html);
                        form.render('select');
                    }
                }
            });
            
            // 渲染表格
            var tableIns = table.render({
                elem: '#dataTable',
                url: '/app/admin/member/list',
                page: true,
                limit: 20,
                limits: [20, 50, 100, 200],
                cols: [[
                    {field: 'id', title: 'ID', width: 70, align: 'center', sort: true},
                    {field: 'groupname', title: '会员组', width: 100, align: 'center', templet: function(d) {
                        return '<span class="layui-badge layui-badge-gray">' + (d.groupname || '') + '</span>';
                    }},
                    {field: 'username', title: '用户名', width: 120, align: 'center', templet: function(d) {
                        return '<span class="text-primary" style="cursor:pointer" data-id="' + d.id + '" data-action="editUser">' + (d.username || '') + '</span>';
                    }},
                    {field: 'userbankname', title: '姓名', width: 100, align: 'center'},
                    {field: 'parent_username', title: '上线', width: 100, align: 'center'},
                    {field: 'proxy_text', title: '类型', width: 80, align: 'center', templet: function(d) {
                        return '<span class="layui-badge layui-badge-gray">' + (d.proxy_text || '') + '</span>';
                    }},
                    {field: 'jinjijilu', title: '晋级记录', width: 100, align: 'center'},
                    {field: 'balance', title: '金额', width: 120, align: 'center', templet: function(d) {
                        return '<span class="text-primary" style="cursor:pointer" data-id="' + d.id + '" data-action="editBalance">' + parseFloat(d.balance || 0).toFixed(3) + '</span>';
                    }},
                    {field: 'point', title: '积分', width: 100, align: 'center', templet: function(d) {
                        return '<span class="text-primary" style="cursor:pointer" data-id="' + d.id + '" data-action="editPoint">' + (d.point || 0) + '</span>';
                    }},
                    {field: 'yebmoney', title: '余额宝', width: 100, align: 'center'},
                    {field: 'xima', title: '洗码余额', width: 120, align: 'center', templet: function(d) {
                        return '<span class="text-primary" style="cursor:pointer" data-id="' + d.id + '" data-action="editXima">' + parseFloat(d.xima || 0).toFixed(3) + '</span>';
                    }},
                    {field: 'logintime_text', title: '登陆时间', width: 120, align: 'center'},
                    {field: 'loginsource', title: '登陆来源', width: 100, align: 'center'},
                    {field: 'isonline_text', title: '状态', width: 80, align: 'center', templet: function(d) {
                        var cls = d.isonline_text === '在线' ? '' : 'layui-badge-gray';
                        return '<span class="layui-badge ' + cls + '">' + d.isonline_text + '</span>';
                    }},
                    {field: 'islock_text', title: '封禁', width: 80, align: 'center', templet: function(d) {
                        var checked = d.islock == 0 ? 'checked' : '';
                        return '<input type="checkbox" lay-skin="switch" lay-text="正常|锁定" ' + checked + ' data-id="' + d.id + '" class="lock-switch"/>';
                    }},
                    {fixed: 'right', title: '资料', width: 200, align: 'center', toolbar: '#infoTpl'},
                    {fixed: 'right', title: '操作', width: 180, align: 'center', toolbar: '#operationTpl'}
                ]],
                done: function() {
                    // 重新渲染开关
                    form.render('checkbox');
                    // 设置按钮样式
                    setButtonStyles();
                }
            });
            
            // 搜索
            form.on('submit(search)', function(data) {
                tableIns.reload({
                    where: data.field,
                    page: {
                        curr: 1
                    }
                });
                return false;
            });
            
            // 添加会员
            $('#addBtn').on('click', function() {
                layer.msg('添加会员功能开发中...', {icon: 0});
            });
            
            // 表格行工具事件
            table.on('tool(dataTable)', function(obj) {
                var data = obj.data;
                
                if (obj.event === 'edit') {
                    // 编辑会员
                    layer.open({
                        type: 2,
                        title: '编辑会员 - ' + data.username,
                        area: ['700px', '90%'],
                        content: '/app/admin/member/edit?id=' + data.id,
                        end: function() {
                            tableIns.reload();
                        }
                    });
                } else if (obj.event === 'delete') {
                    // 删除会员
                    layer.confirm('确认删除会员【' + data.username + '】吗？', {icon: 3, title:'提示'}, function(index) {
                        $.ajax({
                            url: '/app/admin/member/delete',
                            type: 'POST',
                            data: {id: data.id},
                            dataType: 'json',
                            success: function(res) {
                                if (res.code === 0) {
                                    layer.msg('已删除!', {icon: 1});
                                    tableIns.reload();
                                } else {
                                    layer.msg(res.msg || '删除失败', {icon: 2});
                                }
                            }
                        });
                        layer.close(index);
                    });
                } else if (obj.event === 'kick') {
                    // 踢出会员
                    layer.confirm('确认踢出会员【' + data.username + '】吗？', {icon: 3, title:'提示'}, function(index) {
                        $.ajax({
                            url: '/app/admin/member/kick',
                            type: 'POST',
                            data: {id: data.id},
                            dataType: 'json',
                            success: function(res) {
                                if (res.code === 0) {
                                    layer.msg('已踢出!', {icon: 1});
                                } else {
                                    layer.msg(res.msg || '踢出失败', {icon: 2});
                                }
                            }
                        });
                        layer.close(index);
                    });
                } else if (obj.event === 'info') {
                    // 资料
                    layer.open({
                        type: 2,
                        title: '会员资料 - ' + data.username,
                        area: ['600px', '80%'],
                        content: '/app/admin/member/info?id=' + data.id
                    });
                } else if (obj.event === 'balance') {
                    // 帐变
                    layer.open({
                        type: 2,
                        title: '帐变记录 - ' + data.username,
                        area: ['90%', '90%'],
                        content: '/app/admin/member/balance-log?uid=' + data.id
                    });
                } else if (obj.event === 'children') {
                    // 下级
                    layer.open({
                        type: 2,
                        title: '下级会员 - ' + data.username,
                        area: ['90%', '90%'],
                        content: '/app/admin/member/children?parentid=' + data.id
                    });
                }
            });
            
            // 点击金额/积分/洗码编辑
            $(document).on('click', '[data-action="editBalance"]', function() {
                var id = $(this).data('id');
                layer.open({
                    type: 2,
                    title: '修改金额',
                    area: ['500px', '450px'],
                    content: '/app/admin/member/edit-balance?id=' + id,
                    end: function() {
                        tableIns.reload();
                    }
                });
            });
            
            $(document).on('click', '[data-action="editPoint"]', function() {
                var id = $(this).data('id');
                layer.open({
                    type: 2,
                    title: '修改积分',
                    area: ['500px', '400px'],
                    content: '/app/admin/member/edit-point?id=' + id,
                    end: function() {
                        tableIns.reload();
                    }
                });
            });
            
            $(document).on('click', '[data-action="editXima"]', function() {
                var id = $(this).data('id');
                layer.open({
                    type: 2,
                    title: '修改洗码余额',
                    area: ['500px', '400px'],
                    content: '/app/admin/member/edit-xima?id=' + id,
                    end: function() {
                        tableIns.reload();
                    }
                });
            });
            
            // 点击用户名编辑
            $(document).on('click', '[data-action="editUser"]', function() {
                var id = $(this).data('id');
                layer.open({
                    type: 2,
                    title: '编辑会员',
                    area: ['700px', '90%'],
                    content: '/app/admin/member/edit?id=' + id,
                    end: function() {
                        tableIns.reload();
                    }
                });
            });
            
            // 锁定开关
            $(document).on('change', '.lock-switch', function() {
                var id = $(this).data('id');
                var isLock = $(this).prop('checked') ? 0 : 1;
                layer.msg('锁定功能开发中...', {icon: 0});
            });
            
            // 页面加载完成后设置按钮样式
            setButtonStyles();
        });
    </script>
</body>
</html>

